---
title: "get_grid_from_quadkeys"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{get_grid_from_quadkeys}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---





# Create a raster from variables reported by Quadkeys for a specified map area and level of detail

### Step 1: Creata a grid of quadkeys

#### 1.1 Define the area



First, we should define the `xmin`, `xmax`, `ymin` and `ymax` that will delimit 
the area for the QuadKey grid creation.

For this example, we have selected `xmin` = -59, `xmax` = -57, `ymin` = -35,
`ymax` = -34. Let's plot them as points.

![plot of chunk unnamed-chunk-2](figure/unnamed-chunk-2-1.png)

#### 1.2 Select the level of detail

The QuadKey grid can have a level of detail between 1 (less detail) to 23 
(more detail). 

The function `create_qk_grid` will return three outputs: 

1. `grid$data` a dataframe with `tileX`, `tileY` and the QuadKey value for 
each element of the grid
  
2. `grid$num_rows` the number of rows and
  
3. `grid$num_cols` the number of columns of the grid.


```r
grid <-  create_qk_grid(
               xmin = -59,
               xmax = -57,
               ymin = -35,
               ymax = -34,
               level = 12)
head(grid$data)
#>   tileX tileY      quadkey
#> 1  1376  2473 210321302002
#> 2  1376  2472 210321302000
#> 3  1376  2471 210321300222
#> 4  1376  2470 210321300220
#> 5  1376  2469 210321300202
#> 6  1376  2468 210321300200
```

#### 1.3 Get the grid coordinates from the QuadKeys

The coordinates are extracted from the QuadKeys 
using the function `extract_qk_coords()`


```r
grid_coords <- extract_qk_coord(data = grid$data)
head(grid_coords)
#> Simple feature collection with 6 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -59.0625 ymin: -34.958 xmax: -59.0625 ymax: -34.59704
#> Geodetic CRS:  WGS 84
#>   tileX tileY      quadkey                   geometry
#> 1  1376  2473 210321302002   POINT (-59.0625 -34.958)
#> 2  1376  2472 210321302000 POINT (-59.0625 -34.88593)
#> 3  1376  2471 210321300222  POINT (-59.0625 -34.8138)
#> 4  1376  2470 210321300220 POINT (-59.0625 -34.74161)
#> 5  1376  2469 210321300202 POINT (-59.0625 -34.66936)
#> 6  1376  2468 210321300200 POINT (-59.0625 -34.59704)
```
We can visualize the points in the map to understand better the results.

![plot of chunk unnamed-chunk-3](figure/unnamed-chunk-3-1.png)
We have a grid of points representing the QuadKeys. Remember that these points 
represent the upper-left corner of each QuadKey, which might give the impression
that they do not precisely cover the entire area. 
  
  
#### 1.4 Conversion to polygons
Now, let's proceed to create the polygons.


```r
polygrid = grid_to_polygon(grid_coords)
head(polygrid)
#> Simple feature collection with 6 features and 1 field
#> Geometry type: POLYGON
#> Dimension:     XY
#> Bounding box:  xmin: -57.04102 ymin: -34.37971 xmax: -56.95312 ymax: -33.94336
#> Geodetic CRS:  WGS 84
#>        quadkey                       geometry
#> 1 210321132133 POLYGON ((-57.04102 -34.016...
#> 2 210321132311 POLYGON ((-57.04102 -34.089...
#> 3 210321132313 POLYGON ((-57.04102 -34.161...
#> 4 210321132331 POLYGON ((-57.04102 -34.234...
#> 5 210321132333 POLYGON ((-57.04102 -34.307...
#> 6 210321310111 POLYGON ((-57.04102 -34.379...
```
![plot of chunk unnamed-chunk-4](figure/unnamed-chunk-4-1.png)

It worked! As you can see here, the coordinates we randomly selected as 
a starting point are situated within the polygons, but not at a 
specific position inside each polygon. This was expected. 

If you want to see the grid, you can also check the app:


```r

qkmap_app()

```

![](qkmap_grid.png)


#### 1.4 Raster creation

Let's generate the raster. The `data_provided` dataset consists of QuadKeys 
linked to a variable value. While this dataset contains QuadKeys within our
defined study area and detail level, not all grid QuadKeys are present.


```r
data('data_provided')
head(data_provided)
#>        quadkey variable
#> 1 210321132133     0.22
#> 2 210321132311     0.56
#> 3 210321132313     0.27
#> 4 210321132331     0.06
#> 5 210321132333     0.88
#> 6 210321310111     0.22
```


I merge `polygrid` and `data_provided` using QuadKey as the key. 
Please note that `data_provided` shouldn't be an `sf` dataset with a geometry 
column for this join to be executed correctly.


```r

data_raster <-  polygrid |>
  dplyr::inner_join(data_provided, 
                    by = c('quadkey'))

head(data_raster)
#> Simple feature collection with 6 features and 2 fields
#> Geometry type: POLYGON
#> Dimension:     XY
#> Bounding box:  xmin: -57.04102 ymin: -34.37971 xmax: -56.95312 ymax: -33.94336
#> Geodetic CRS:  WGS 84
#>        quadkey variable                       geometry
#> 1 210321132133     0.22 POLYGON ((-57.04102 -34.016...
#> 2 210321132311     0.56 POLYGON ((-57.04102 -34.089...
#> 3 210321132313     0.27 POLYGON ((-57.04102 -34.161...
#> 4 210321132331     0.06 POLYGON ((-57.04102 -34.234...
#> 5 210321132333     0.88 POLYGON ((-57.04102 -34.307...
#> 6 210321310111     0.22 POLYGON ((-57.04102 -34.379...
```
Now, we can use the dataframe to create the raster.


```r
raster <-  create_raster(template = data_raster,
              nx = grid$num_cols +1,
              ny = grid$num_rows +1,
              data = data_raster,
              var = 'variable')

raster
#> stars object with 2 dimensions and 1 attribute
#> attribute(s):
#>           Min. 1st Qu. Median      Mean 3rd Qu. Max.
#> variable     0    0.22   0.49 0.5028611    0.76    1
#> dimension(s):
#>   from to offset    delta refsys point x/y
#> x    1 24 -59.06  0.08789 WGS 84 FALSE [x]
#> y    1 15 -33.94 -0.07244 WGS 84 FALSE [y]

# In case you want to save it:
# write_stars(obj = raster,
#             dsn = "raster.tif")
```


![plot of chunk unnamed-chunk-8](figure/unnamed-chunk-8-1.png)

